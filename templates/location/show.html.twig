{% extends 'base.html.twig' %}
{% block title %}{{ location.locationName }} - Détail du lieu{% endblock %}
{% block meta_description %}
<meta name="description" content="Découvrez {{ location.locationName }} à 
{{ location.city }} : {{ location.description|striptags|slice(0, 160) }}..." />
{% endblock %}

{% block body %}
<div>
    {% if location.images|length > 0 %}
    <figure class="h-64 w-full block lg:hidden">
        <img src="{{ location.images[0].imageName }}" alt="{{ location.locationName}}" loading="lazy"
            class="w-full h-full object-cover">
    </figure>
    {% endif %}

    <div class="my-5 mx-6  lg:mx-44">
        <div class="flex flex-col lg:flex-row lg:gap-12 gap-8 lg:mt-10">

            <div class="lg:w-2/3">

                <div class="flex flex-col lg:flex-row gap-10">

                    <div class="lg:w-2/3">
                        <div class="flex items-center justify-between lg:justify-start lg:gap-4">
                            <h1 class="text-2xl lg:text-3xl text-left mb-1 font-semibold ">{{ location.locationName }}
                            </h1>
                            {% if averageRating %}
                            <div class="flex gap-2 text-gray-800 font-light">
                                <p>{{ averageRating|number_format(1, ',', '') }}</p>
                                <div class="text-[0.75rem]">{{ averageRating|round(1, 'floor')|stars|raw }}</div>
                                <p>({{ ratings|length }})</p>
                            </div>
                            {% endif %}
                        </div>
                        <p class="text-gray-500 mt-2">
                            {% if location.type %}
                            {{ location.type.typeName }}
                            {% else %}
                            <span class="text-gray-400">Type inconnu</span>
                            {% endif %}
                        </p>
                        {# discount #}
                        {% if location.discounts|length > 0 %}
                        {% for discount in location.discounts %}
                        {% if discount.isActive %}
                        <div
                            class="border border-violet-700 rounded-md py-2 px-4 flex items-center gap-3 mt-4 lg:mb-5 bg-violet-100 md:w-fit lg:w-fit w-full">
                            <i class="fa-solid fa-tags text-violet-700"></i>
                            <p class=" font-medium text-sm  text-violet-700">Code : <span class="font-semibold">{{
                                    discount.code }}</span> offrant {{ discount.percentage }}% de réduction</p>
                        </div>
                        {% endif %}
                        {% endfor %}
                        {% endif %}

                    </div>

                    <div class="lg:w-1/3 flex flex-col">
                        {% if app.user %}
                        <div class="flex justify-between items-center mt-2 lg:mt-0">
                            <p class="font-semibold text-[1.1rem]">Vous l'avez déjà visité ?</p>

                            <label for="visited-switch" class="inline-flex items-center cursor-pointer">
                                <input id="visited-switch" type="checkbox" class="sr-only peer visited-switch"
                                    data-location-id="{{ location.id }}" {% if app.user and
                                    app.user.hasVisitedLocation(location.id) %}checked{% endif %}>
                                <div
                                    class="relative w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700  peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full  peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5  after:start-[2px] after:bg-white after:border-gray-300 after:border  after:rounded-full after:h-5 after:w-5 after:transition-all  dark:border-gray-600 peer-checked:bg-violet-800 dark:peer-checked:bg-violet-800">
                                </div>
                            </label>
                        </div>
                        {% endif %}



                        <div class="my-8 w-full flex justify-center lg:mt-6 lg:mb-8">
                            <p
                                class="bg-violet-800 py-3 px-2 rounded-3xl text-white font-medium text-center w-fit lg:w-full lg:rounded-2xl btn-violet">
                                <a href="#" id="add-to-itinerary" data-location-id="{{ location.id }}">
                                    Ajouter à mon itinéraire
                                </a>
                            </p>
                        </div>
                    </div>
                </div>

                <ul
                    class="flex justify-between mb-6 font-medium text-[1.1rem] py-3 sticky top-0 z-30 px-5 bg-white shadow-bottom lg:hidden ">
                    <li><a href="#description" id="nav-description" aria-label="Aller à la description"
                            class="underline-bar">Description </a></li>
                    <li><a href="#contact" id="nav-contact" aria-label="Aller au contact"
                            class="underline-bar">Contact</a></li>
                    <li><a href="#infos" id="nav-infos" aria-label="Aller aux infos" class="underline-bar">Infos</a>
                    </li>
                    <li><a href="#reviews" id="nav-reviews" aria-label="Aller aux avis" class="underline-bar">Avis</a>
                    </li>
                </ul>

                <p id="description" class="text-justify lg:text-[0.9rem] ">{{ location.description}}</p>
                <div class="mt-7 lg:mt-3 lg:grid lg:grid-cols-2 flex flex-col gap-8">
                    <div class="flex flex-col gap-8 lg:gap-6">

                        {# ----------------- CONTACT ----------------- #}
                        <section id="contact" class="mt-7">
                            <div class="flex gap-2 items-center mb-5">
                                <i class="fa-solid fa-address-card text-violet-700"></i>
                                <p class="text-[1.1rem] font-semibold ">Contact</p>
                            </div>
                            <div class="flex gap-5">
                                <div class="flex gap-3 items-center bg-violet-100 py-3 px-5 rounded-3xl">
                                    <i class="fa-solid fa-phone text-violet-700"></i>
                                    <p class="text-violet-700 font-medium">{{ location.phoneNumber }}</p>
                                </div>
                                {% if location.website %}
                                <div
                                    class="flex gap-2 items-center bg-violet-100 py-3 px-5 rounded-3xl btn-violet-light">
                                    <i class="fa-solid fa-globe text-violet-700"></i>
                                    <a href="{{ location.website }}" target="_blank"
                                        class="text-violet-700 font-medium">Site web</a>
                                </div>
                                {% endif %}
                            </div>
                        </section>

                        {# ----------------- HORAIRES ----------------- #}
                        <section id="infos" class="mt-7">
                            <div class="flex gap-2 items-center mb-5">
                                <i class="fa-regular fa-clock text-violet-700"></i>
                                <p class="text-[1.1rem] font-semibold text-black ">Horaires</p>
                            </div>
                            {# TODO : changer horaires #}
                            <p class="text-black font-normal">Variables selon la saison, à consulter sur le site
                                internet.</p>
                        </section>
                    </div>
                    <div class="flex flex-col gap-8 lg:gap-6">

                        {# ----------------- ADRESSE ----------------- #}
                        <section class="mt-7">
                            <div class="flex gap-2 items-center mb-5">
                                <i class="fa-solid fa-location-dot text-violet-700"></i>
                                <p class="text-[1.1rem] font-semibold text-black ">Adresse</p>
                            </div>
                            <p class="text-black font-normal">{{ location.address}}, {{ location.zipcode }} {{
                                location.city }}</p>
                        </section>

                        {# ----------------- PRIX ----------------- #}
                        <section class="mt-7">
                            <div class="flex gap-2 items-center mb-5">
                                <i class="fa-solid fa-coins text-violet-700"></i>
                                <p class="text-[1.1rem] font-semibold text-black ">Prix</p>
                            </div>
                            {# TODO : récupérer les prix et les associer à une gamme de prix #}
                            <p class="text-black font-normal">
                                {% if location.minPrice and location.maxPrice %}
                                Le propriétaire a indiqué une fourchette de prix allant de {{ location.minPrice }}€ à {{
                                location.maxPrice }}€.
                                {% else %}
                                <span class="text-gray-400">Prix inconnu</span>
                                {% endif %}
                            </p>
                        </section>
                    </div>
                </div>

                {# ----------------- CARTE ----------------- #}
                <section>
                    <div id="map" class="w-full  rounded-lg h-36 mt-8 inset-shadow-sm inset-shadow-gray-400"
                        data-geo='{{ location.geo ? location.geo|json_encode : "null" }}'>
                    </div>
                </section>
            </div>

            <div class="hidden lg:block w-px bg-gray-200 mx-2"></div>
            <div class="lg:w-1/3">
                {# ----------------- IMAGES ----------------- #}
                <section>
                    <div class="flex gap-2 items-center mb-5">
                        <i class="fa-regular fa-images text-violet-700"></i>
                        <p class="text-[1.1rem] font-semibold text-black ">Photos</p>
                    </div>
                    <div class="wrapper-container-place">
                        <div style="--swiper-navigation-color: #fff; --swiper-pagination-color: #fff"
                            class="swiper mySwiper2">
                            <div class="swiper-wrapper">
                                {% for image in location.images %}
                                <figure class="swiper-slide">
                                    <img src="{{ image.imageName|replace({'/upload/':'/upload/w_800/'}) }}"
                                        alt="{{ location.locationName}}" class="swiper-image"
                                        data-full="{{ image.imageName|replace({'/upload/':'/upload/w_1200/'}) }}">
                                </figure>
                                {% endfor %}
                            </div>
                            <div class="swiper-button-next"></div>
                            <div class="swiper-button-prev"></div>
                        </div>
                        <div thumbsSlider="" class="swiper mySwiper">
                            <div class="swiper-wrapper">
                                {% for image in location.images %}

                                <figure class="swiper-slide">
                                    <img src="{{ image.imageName|replace({'/upload/':'/upload/w_400/'}) }}"
                                        alt="{{ location.locationName}}"
                                        data-full="{{ image.imageName|replace({'/upload/':'/upload/w_1200/'}) }}">
                                </figure>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {# MODAL #}
                    <div id="image-modal"
                        class="hidden fixed inset-0 w-screen h-screen bg-black/80 z-[9999] justify-center items-center">
                        <div class="relative flex justify-center items-center">
                            <button id="close-modal"
                                class="absolute top-[-15px] md:top-[-50px] right-[-15px] md:right-[-40px] bg-white border-0 rounded-full w-10 h-10 text-2xl cursor-pointer flex items-center justify-center shadow-lg z-10">&times;</button>
                            <img id="modal-img" src="" alt="Image grand format"
                                class="max-w-[90vw] max-h-[80vh] rounded-[12px] shadow-[0_0_20px_#222] h-fit">
                        </div>
                    </div>
                </section>

                {# ----------------- AVIS ----------------- #}
                <section id="reviews" class="mt-7">
                    <div class="lg:flex lg:justify-between lg:mb-3">
                        <div class="flex gap-2 items-center mb-5">
                            <i class="fa-regular fa-star text-violet-700"></i>
                            <p class="text-[1.1rem] font-semibold text-black ">Avis <span
                                    class="text-sm font-light text-gray-700">({{ ratings|length }})</span></p>
                        </div>
                        <div class="hidden lg:block">
                            <p
                                class=" bg-violet-800 px-12 py-2 rounded-2xl text-white font-medium text-center w-fit btn-violet">
                                <a href="{{ path('new_rating', {'locationId': location.id})}}">Laisser un avis</a>
                            </p>
                        </div>

                    </div>

                    <div class="swiper mySwiperReviews" style="--swiper-pagination-color: #5D0EC0">
                        <div class="swiper-wrapper">
                            {% for review in ratings|slice(0, 10) %}
                            <div class="swiper-slide">
                                <div
                                    class="h-32 max-h-32 line-clamp-4 border border-violet-200 rounded-xl py-3 px-4 w-full">
                                    <div class="flex justify-between mb-1">
                                        <div class="flex items-center  text-violet-700 text-[0.75rem]">
                                            {{ review.rating|stars|raw }}

                                            {% if app.user and app.user == review.user %}
                                            <a href="{{ path('edit_rating', { id: review.id }) }}"
                                                title="Modifier votre avis"
                                                class="text-gray-500 hover:text-violet-700 transition ml-2 mr-1">
                                                <i class="fa-solid fa-pen-to-square"></i>
                                            </a>

                                            <form method="post" action="{{ path('delete_rating', { id: review.id }) }}"
                                                onsubmit="return confirm('Voulez-vous vraiment supprimer cet avis ?');"
                                                class="inline">
                                                <input type="hidden" name="_token"
                                                    value="{{ csrf_token('delete_rating_' ~ review.id) }}">
                                                <button type="submit" title="Supprimer votre avis"
                                                    class="text-gray-500 hover:text-red-600 transition cursor-pointer">
                                                    <i class="fa-solid fa-trash"></i>
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>


                                        <p class="text-[0.75rem] text-gray-500">
                                            {{ review.user.username ?? 'Anonyme' }} –
                                            {{ review.ratingDate|date('d/m/Y') }}
                                        </p>
                                    </div>
                                    <p class="text-[0.9rem]">
                                        {{ review.comment ?? 'Pas de commentaire' }}
                                    </p>
                                </div>
                            </div>
                            {% else %}
                            <div class="swiper-slide">
                                <p class="text-gray-500 text-center py-8">Aucun avis pour le moment.</p>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="swiper-pagination reviews-pagination"></div>
                    </div>

                </section>

            </div>
        </div>
    </div>

    {# ----------------- A PROXIMITE ----------------- #}
    <section class="mt-7  h-72  bg-[#393939] p-5 lg:px-44">
        <h2 class="text-white font-semibold text-xl mb-3 pl-3">À proximité</h2>
        <div class="swiper mySwiperNearby">
            <div class="swiper-wrapper">
                {% for nearbyLocation in nearby %}
                <div class="swiper-slide">
                    <a href="{{ path('location_detail', {'id': nearbyLocation.id}) }}"
                        class="flex flex-col items-start">
                        <figure class="mb-3 w-[225px] h-[135px] relative">
                            {% if nearbyLocation.images|length > 0 %}
                            <img src="{{ nearbyLocation.images[0].imageName|replace({'/upload/':'/upload/w_300/'}) }}"
                                alt="{{ nearbyLocation.locationName }}" loading="lazy"
                                class="w-full h-full object-cover rounded-xl">
                            {% else %}
                            <div
                                class="w-full h-full bg-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-500 text-sm">
                                <i class="fa-regular fa-image text-2xl mb-1"></i>
                                <span>Aucune image</span>
                            </div>
                            {% endif %}
                        </figure>

                        <p>
                            <span class="text-white">{{ nearbyLocation.locationName }}</span>
                            <span class="text-[#cdd1d7] text-sm"> - {{ nearbyLocation.city }}</span>
                        </p>
                        {% if nearbyLocation.type %}
                        <p class="text-[#cdd1d7] text-sm">{{ nearbyLocation.type.typeName }}</p>
                        {% endif %}
                    </a>
                </div>
                {% else %}
                <div class="swiper-slide">
                    <p class="text-neutral-400 text-center py-8">Aucun lieu trouvé à proximité.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
</div>


<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src='https://unpkg.com/maplibre-gl@5.6.1/dist/maplibre-gl.js'></script>
<script src="{{ asset('js/itinerary-modal.js') }}"></script>
<script src="{{ asset('js/visited-location.js') }}"></script>

{#
<script src="{{ asset('js/map.js') }}"></script> #}
<script>
    document.addEventListener('scroll', () => {
        // SCROLL SECTION MOBILE
        const sections = ['description', 'contact', 'infos', 'reviews'];
        let active = sections[0];

        for (const id of sections) {
            const element = document.getElementById(id);
            if (element && element.getBoundingClientRect().top <= 80) {
                active = id;
            }
        }

        sections.forEach(id => {
            const nav = document.getElementById('nav-' + id);
            if (nav) nav.classList.toggle('active-underline', id === active);
        });
    });


    document.addEventListener('DOMContentLoaded', function () {

        // SWIPER IMAGES
        const swiper = new Swiper(".mySwiper", {
            loop: true,
            spaceBetween: 10,
            slidesPerView: 3,
            freeMode: true,
            watchSlidesProgress: true,
        });

        const swiper2 = new Swiper(".mySwiper2", {
            loop: true,
            spaceBetween: 10,
            mousewheel: true,
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
            thumbs: {
                swiper: swiper,
            },
        });

        // SWIPER COMMENTS
        new Swiper(".mySwiperReviews", {
            slidesPerView: 1,
            spaceBetween: 20,
            pagination: {
                el: ".reviews-pagination",
                clickable: true,
            },
        });

        // SWIPER NEARBY
        new Swiper(".mySwiperNearby", {
            slidesPerView: 5,
            spaceBetween: 70,
        });



        // MAP
        const mapDiv = document.getElementById('map');
        const geoData = mapDiv.dataset.geo ? JSON.parse(mapDiv.dataset.geo) : null;

        if (geoData) {
            const [long, lat] = geoData.coordinates;

            const map = new maplibregl.Map({
                container: 'map',
                style: "https://api.jawg.io/styles/jawg-lagoon.json?access-token=5Hj1eNrhxICEmCUA3n50cFITkKNPsXWcZFw3JKMebObcRBGRIBQnT1RQlRQ4RRoG",
                zoom: 16,
                center: [long, lat]
            });

            maplibregl.setRTLTextPlugin(
                'https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.3.0/dist/mapbox-gl-rtl-text.js'
            );

            const element = document.createElement('div');
            element.style.backgroundImage = 'url("/img/regular-pin-small.png")';
            element.style.width = "45px";
            element.style.height = "45px";
            element.style.backgroundSize = "100%";

            new maplibregl.Marker({ element: element }).setLngLat([long, lat]).addTo(map);
        }


        // MODALE IMAGES
        const modal = document.getElementById("image-modal");
        const modalImg = document.getElementById("modal-img");
        const closeBtn = document.getElementById("close-modal");

        document.querySelectorAll('.swiper-image').forEach(img => {
            img.addEventListener('click', function () {
                modalImg.src = img.dataset.full;
                modal.style.display = 'flex';
            });
        });
        closeBtn.addEventListener('click', function () {
            modal.style.display = 'none';
            modalImg.src = '';
        });
        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                modal.style.display = 'none';
                modalImg.src = '';
            }
        });
    });

</script>

{# ---------------- MODALE ITINÉRAIRE ---------------- #}
{% include 'location/partials/_itinerary_modal.html.twig' %}
{% include 'location/partials/_location_visited_modal.html.twig' %}

{% endblock %}